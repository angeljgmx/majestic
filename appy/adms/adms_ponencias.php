<?php 
    /********************************************************/
    /* Administrador Web SmartNova
    /* CRUD - tbla_ponc
    /* 02-7-2016
    /********************************************************/

//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------// 

    // Inicio de sesion
    session_start(); 
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------// 

    // Ubicación del archivo 
    $path = "../../"; 
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------// 

    // Inclusion de archivos necesarios 
    require_once $path."core/core.php"; 
    Core($path);
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------// 

    // Seguridad 
    Seguridad($path);
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------// 

    // Identificador del modulo
    $_SESSION['mdlo_code'] = "MD-EVNTS";
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------// 

    // Control de errores
    $debug = DEBUG;
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------// 

    // Crear la instancia y conectar a la BD
    $conec = new db();
    $conec->dbConexion(); 
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------//            

    // Objetivo para los formularios, los enlaces y las funciones 
    $objetivo = basename($_SERVER["PHP_SELF"]); 
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------// 

    // Permisos del modulo
    $permisos = PermisosModulo($path); 
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------// 

    //Encabezado de la pagina
    $page_title = "Ponencias";
    $meta = "";
    $css = "";
    $js = "";
    $actions_pagebar = array('nuevo_registro' => '', 'tabla_consulta' => '', 'panel_control' => '');
    $config = [];
    CommonHeader($path, $page_title, $meta, $css, $js, $objetivo, $actions_pagebar, $config);
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------// 

    // Validacion de la session
    if (SessionValidate($path, "adms")){
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------// 

        // Reecepcion del id del evento
        if (null !== filter_input(INPUT_GET, 'evnt_id', FILTER_SANITIZE_NUMBER_INT)){ 
            $_SESSION['evnt_id'] = filter_input(INPUT_GET, 'evnt_id', FILTER_SANITIZE_NUMBER_INT);
            
            $sql_evnt = "SELECT id, evnt_nomb FROM tbla_evnt WHERE id = ".$_SESSION['evnt_id'];
            $query_evnt = $conec->dbQuery($sql_evnt, $debug);
            $datos_evnt = $conec->dbFetchObjet($query_evnt);
            
            $_SESSION['evnt_nomb'] = $datos_evnt->evnt_nomb;
        }

        if ((isset($_SESSION['evnt_id']))){ 
            
            
        
            // Recepcion  de variable de opcion por GET
            $op = OptionGetPost($path);

            $table = "tbla_ponc";
            $captcha ="off";
            $select_sql = "SELECT tbla_prtp.id, CONCAT(prtp_nom1, ' ', prtp_nom2, ' ', prtp_apl1, ' ', prtp_apl2) AS prtp_prtp, "
                ."tbla_prev.id AS prev_id, prev_evnt, "
                ."tbla_evnt.id AS evnt_id "
                ."FROM tbla_prtp "
                ."INNER JOIN tbla_prev ON (prev_prtp = tbla_prtp.id) "
                ."INNER JOIN tbla_evnt ON (prev_evnt = tbla_evnt.id) "
                ."WHERE tbla_evnt.id = ".$_SESSION['evnt_id']." "
                ."ORDER BY prtp_prtp";
            $config['datatable_title'] = "Ponencias ";
            $config['datatable_actions_path'] = $path."app/";
            $title = "Gesti&oacute;n de Datos";           
            $config['portlet_subtitle'] = $_SESSION['evnt_nomb'];
            // Datos del formulario
            $form =  array(
                array ('campo' => 'evnt_nomb', 'nombre' => 'Evento', 'tipo_objeto' => 'input_text', 'tipo_dato' => 'cleartext', 'readonly' => TRUE, 'value' => $_SESSION['evnt_nomb'], 'adicional' => TRUE, 'ayuda' => 'Nombre del evento'), 
                array ('campo' => 'ponc_evnt', 'tipo_objeto' => 'input_hidden', 'tipo_dato' => 'integer', 'value' => $_SESSION['evnt_id']), 
                array ('campo' => 'ponc_ttlo', 'nombre' => 'T&iacute;tulo', 'tipo_objeto' => 'input_text', 'tipo_dato' => 'cleartext'), 
                array ('campo' => 'ponc_prtp', 'nombre' => 'Ponente', 'tipo_objeto' => 'select_sql', 'select_type' => 'search', 'tipo_dato' => 'integer', 'sql_select' => $select_sql, 'tabla' => 'tbla_prtp', 'orden' => 'id', 'valor' => 'id', 'descripcion' => 'prtp_prtp'),    
                array ('campo' => 'ponc_fchr', 'nombre' => 'Fecha y Hora', 'tipo_objeto' => 'input_datetime_picker', 'tipo_dato' => 'datetime'),               
                array ('campo' => 'ponc_estd', 'nombre' => 'Estado', 'tipo_objeto' => 'input_radio', 'tipo_dato' => 'bool', 'opcion0' => 'Inactivo', 'opcion1' => 'Activo'), 
            );

            // Switch para las opciones e lista, nuevo registro, eliminar, modificar, ver detalles
            switch ($op) {
//========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================// 

                // Opcion de lista
                case "listar":
                    if ($permisos['cons'] == TRUE){
                        $id_tabla = FALSE;
                        $sql = "SELECT tbla_ponc.id, ponc_prtp,  ponc_ttlo, ponc_evnt, ponc_estd, ponc_freg, "
                            ."tbla_evnt.id AS evnt_id, evnt_nomb, "
                            ."tbla_prtp.id AS prtp_id, CONCAT(prtp_nom1, ' ', prtp_nom2, ' ', prtp_apl1, ' ', prtp_apl2) AS prtp_prtp "
                            ."FROM tbla_ponc "
                            ."INNER JOIN tbla_evnt ON (ponc_evnt = tbla_evnt.id) "
                            ."INNER JOIN tbla_prtp ON (ponc_prtp = tbla_prtp.id) "
                            ."WHERE ponc_evnt = ".$_SESSION['evnt_id']." "
                            ."ORDER BY prtp_prtp DESC";
                        $legend = $page_title;
                        $config['datatable_portled_subtitle'] = "- ".$_SESSION['evnt_nomb'];
                        $dt_acciones = array('editar' => '', 'eliminar' => '');
                        $datatable = array(
                            array('nombre' => 'Estado', 'width' => '', 'campo' => 'ponc_estd', 'formato' => 'radio', 'opcion0' => 'Inactivo', 'opcion1' => 'Activo'), 
                            array('nombre' => 'Nombres y Apellidos', 'width' => '', 'campo' => 'prtp_prtp', 'formato' => 'normal'),
                            array('nombre' => 'T&iacute;tulo', 'width' => '', 'campo' => 'ponc_ttlo', 'formato' => 'normal'),
                            array('nombre' => 'Fecha de registro', 'width' => '', 'campo' => 'ponc_freg', 'formato' => 'datetime'), 
                        );
                        DataTable($path, $sql, $objetivo, $dt_acciones,  $datatable, $config);
                    }
                    else {
                        PermisosMensajeError($path, FALSE);
                    }
                break;
//========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================// 

                // Opcion de insertar registros
                case "insertar":
                    if ($permisos['insr'] == TRUE){
                        if (isset($_POST["control"]) && ($_POST["control"] == 1)){
                            $criterio = "(ponc_prtp = {ponc_prtp}) AND (ponc_ttlo = {ponc_ttlo}) AND (ponc_evnt = {ponc_evnt})";
                            FormProcess($path, $op, $table, $criterio, $form, $captcha, $config);
                        }

                        FormShow($path, $op, $title, $objetivo, $form, $table, $captcha, $config);
                    }
                    else {
                        PermisosMensajeError($path, FALSE);
                    }
                break;
//========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================// 

                // Opcion de editar registros
                case "editar":
                    if ($permisos['edit'] == TRUE){
                        if (isset($_POST["control"]) && ($_POST["control"] == 1)){
                            $criterio = "";
                            FormProcess($path, $op, $table, $criterio, $form, $captcha, $config);
                        }

                        FormShow($path, $op, $title, $objetivo, $form, $table, $captcha, $config);
                    }
                    else {
                        PermisosMensajeError($path, FALSE);
                    }
                break;
//========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================// 

                // Opcion de eliminar registros
                case "eliminar":
                    if ($permisos['elim'] == TRUE){
                        Eliminar($path, $objetivo, $table);
                    }
                    else {
                        PermisosMensajeError($path, FALSE);
                    }    
                break;
//========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================// 

            } // Fin del switch
            
        } //Fin de la verificación del id
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------// 

    } // Fin de la validacion de la session
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------// 

    //Pie de pagina
    $sjs = "";
    CommonFooter($path, $sjs, $config);
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------// 

?>