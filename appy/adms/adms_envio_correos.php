<?php 
    /********************************************************/
    /* Administrador Web SmartNova
    /* CRUD - itlb_bltn
    /* 02-7-2016
    /********************************************************/

//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------// 

    // Inicio de sesion
    session_start(); 
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------// 

    // UbicaciÃ³n del archivo 
    $path = "../../"; 
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------// 

    // Inclusion de archivos necesarios 
    require_once $path."core/core.php"; 
    Core($path);
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------// 

    // Seguridad 
    Seguridad($path);
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------// 

    // Control de errores
    $debug = DEBUG;

    // Crear la instancia y conectar a la BD
    $conec = new itl_db();
    $conec->itl_dbConexion(); 
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------//            

    // Identificador del modulo
    $_SESSION['mdlo_code'] = "MD-MAILS-SUSCRT";
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------// 

    // Objetivo para los formularios, los enlaces y las funciones 
    $objetivo = basename($_SERVER["PHP_SELF"]); 
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------// 

    // Permisos del modulo
    $permisos = PermisosModulo($path); 
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------// 

    //Encabezado de la pagina
    $page_title = "Correos Suscritos";
    $meta = "";
    $css = "";
    $js = "";
    $actions_pagebar = array('nuevo_registro' => '', 'tabla_consulta' => '', 'panel_control' => '');
    $config = [];
    CommonHeader($path, $page_title, $meta, $css, $js, $objetivo, $actions_pagebar, $config);
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------// 

    // Validacion de la session
    if (SessionValidate($path, "adms")){
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------// 

        $datos_envio = array();
        $n_emails = 0;
        $n_emails_c = 0;
        if ((isset($_POST['action'])) && ($_POST['action'] == "enviar")){
            
            
            // Recepcion de variables del formulario
            $mail_asnt = $_POST['mail_asnt'];           // Asunto
            $mail_mnsj = $_POST['mail_mnsj'];           // Mensaje

            foreach ($_POST['mail_ciud'] as $mail_ciud){

                $sql_registro = "SELECT * FROM itlb_csus WHERE a = '".$mail_ciud."'";
                $query_registro = $conec->itl_dbQuery($sql_registro, $debug);
                while($datos_registro = $conec->itl_dbFetchObjet($query_registro)){
                    
                    $sql_email = "SELECT * FROM itlb_agml WHERE (agml_agnd = ".$datos_registro->id.") AND (agml_estd = 1)" ;
                    $query_email = $conec->itl_dbQuery($sql_email, $debug);
                    while($datos_email = $conec->itl_dbFetchObjet($query_email)){

                        $n_emails++;
                        
                        // Array con los direcciones de correo y los destinatarios
                        $datos_envio[$n_emails]['destinatario'] = $datos_registro->agnd_agnc;
                        $datos_envio[$n_emails]['email'] = $datos_email->agml_mail;  
                    }                                     
                }   
            }           
            

            //SMTP needs accurate times, and the PHP time zone MUST be set
            //This should be done in your php.ini, but this is how to do it if you don't have access to that
            date_default_timezone_set('Etc/UTC');

            // Librerias necesarias
            //require_once $path.'plugins/mail/class.phpmailer.php';
            //require_once $path.'plugins/mail/class.smtp.php';
            require_once $path.'includes/dataforms.php';
            require $path.'components/PHPMailer-master/PHPMailerAutoload.php';

            //Create a new PHPMailer instance
            $mail = new PHPMailer;

            //Tell PHPMailer to use SMTP
            $mail->isSMTP();

            //Enable SMTP debugging
            // 0 = off (for production use)
            // 1 = client messages
            // 2 = client and server messages
            
            if ($debug == "on"){
                $mail->SMTPDebug = 2;
            }
            else {
                $mail->SMTPDebug = 0;
            }

            // Salida del depurador de errores
            $mail->Debugoutput = 'html';

            // Nombre del servidor de correos
            $mail->Host = 'elitetravelve.com';

            // Numero de puerto de servidor de correo
            $mail->Port = 587;

            // Seguridad del servidor de correo - ssl (deprecated) o tls
            $mail->SMTPSecure = '';

            // Autentificado del servidor de correo
            $mail->SMTPAuth = true;
            

            // Nombre de usuario del servidor SMTP
            $mail->Username = "promociones@elitetravelve.com";

            // Password del usuario
            $mail->Password = "Elite123Travel!";

            // Nombre y direccion de correo que vera el destinatario
            $mail->setFrom('promociones@elitetravelve.com', 'Elite Travel');

            // Direccion de cooreo alternativo
            $mail->addReplyTo('no-responder@elitetrvelve.com', 'Elite Tarvel');
            
            // Archivos adjuntos
            $archivos_adjuntos = "";
            foreach ($_POST['mail_adjn'] as $mail_adjn){
                $mail->AddAttachment($path."uploads/email/".basename($mail_adjn));
                
                $archivos_adjuntos .= basename($mail_adjn).",";
            }
            
            // Hash de seguridad
            $fecha_hora = date("d\-m\-Y / h\:i\ a");
            $hash = md5("Elite Travel".$fecha_hora);
            
            
            // Configuracion del mensaje de correo
            $mail->From = 'promociones@elitetravelve.com';
            $mail->FromName = 'Elite Travel';
            $mail->Subject = $mail_asnt;
            //$mail->Body = $mail_mnsj;
           
            $mail->AltBody = strip_tags($mail_mnsj);
            
            $direcciones_email = "";
            $emails_error = "";
            
            $mserror = "success";

            
            // Indicamos cuales son las direcciones de destino del correo y enviamos los mensajes           
            for ($j = 1; $j <= $n_emails; $j++) { 
                
                flush(); 

                
                $mensaje_html = $mail_mnsj;
                
                // Enlace para desactivar el envio de correos a la direccion actual
                $mensaje_html.= "<p>Si no desea recibir mas nuestros mensajes, haga click en el siguiente enlace \n"
                    ."<a href=\"www.elitetravelve.com/cancelar_envio_email.php?sc=".$hash."&email=".$datos_envio[$j]['email']."\" target=\"_blank\">Cancelar el env&iacute;o de correo</a> \n"
                    ."</p>";

                // Mensaje
                $mail->MsgHTML($mensaje_html);
                
                // Direcciones a enviar mensaje
                $mail->addAddress($datos_envio[$j]['email'], 'Promociones Elite Travel');
                 
                if (!$mail->send()) {
                    
                    $mserror = "warning";
                    $emails_error .= $datos_envio[$j]['email'].", "; 
                    
                    echo "<div class=\"col-md-12\"> \n"
                        ."<div class=\"icon-box style5\"> \n"
                        ."<i class=\"soap-icon-message bgcolor_red\"></i> \n"
                        ."<div class=\"description\"> \n"
                        ."<small>El correo no se pudo enviar con &eacute;xito a la direcci&oacute;n </small> \n"
                        ."<h5>".$datos_envio[$j]['email']."</h5> \n"
                        ."</div> \n"
                        ."</div> \n"
                        ."</div> \n";
                }
                else{                    
                    echo "<div class=\"col-md-12\"> \n"
                        ."<div class=\"icon-box style5\"> \n"
                        ."<i class=\"soap-icon-message bgcolor_green\"></i> \n"
                        ."<div class=\"description\"> \n"
                        ."<small>Correo enviado con &eacute;xito a la direcci&oacute;n </small> \n"
                        ."<h5>".$datos_envio[$j]['email']."</h5> \n"
                        ."</div> \n"
                        ."</div> \n"
                        ."</div> \n";
                }
                $mail->ClearAddresses();
                
                $direcciones_email .= $datos_envio[$j]['email'].",";
                
                ob_flush(); 
            }
           
            // Consulta para guardar el historial de correos enviados
            $sql_hitorial_correos = "INSERT INTO itlb_aghc (aghc_mail, aghc_hash, aghc_asnt, aghc_mnsj, aghc_adjn, aghc_estd) "
                ."VALUES ('".$direcciones_email."', '".$hash."', '".$mail_asnt."', '".$mail_mnsj."', '".$archivos_adjuntos."', '1')";
            $query = $conec->itl_dbQuery($sql_hitorial_correos, $debug);

            
            // Mensajes de error
            if ($mserror == "warning") {
                $mensaje = "&iexcl;Ha ocurrido un error!. El mensaje no pudo ser enviado a las siguientes direcciones de correo: ".$emails_error;
                Mensaje($mserror, $mensaje);
            }
            else {
                $mensaje = "El mensaje fue enviado con &eacute;xito a todos los destinatarios";
                $mserror = "success";
                Mensaje($mserror, $mensaje);
            }

	}
//--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------//
        else {
            // Ayuda
            echo "<div class=\"row\"> \n"
                ."<div class=\"sidebar col-sm-4 col-md-3\"> \n"
                ."<div class=\"travelo-box book-with-us-box\"> \n"

                ."<h3 class=\"box-title\">Ayuda</h3> \n"       
                ."<ul> \n"; 

            echo "<li> \n"
                ."<i class=\"soap-icon-check circle\"></i> \n"
                ."<h5 class=\"title\">Pa&iacute;ses: </h5> \n"
                ."<p>Pa&iacute;ses a los que desea enviar correos \n"
                ."</p> \n"
                ."</li> \n";

            echo "</div> \n"
                ."</div><!-- .left-sidebar --> \n";
    //--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------//

             echo "<div id=\"main\" class=\"col-sm-8 col-md-9\"> \n"
                ."<div class=\"travelo-box book-with-us-box\"> \n"
                ."<h3 class=\"box-title\">Envio de correos Masivos</h3> \n"

                ."<fieldset class=\"form-fieldset\"> \n" 
                ."<form id=\"carga_excel\" name=\"carga_excel\" action=\"$objetivo\" enctype=\"multipart/form-data\" method=\"post\" class=\"general formulario\" data-validate=\"parsley\"> \n";   

    //--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------//
            
            // Asunto
            echo "<div class=\"form-group\"> \n"
                ."<label for=\"mail_asnt\"\">Asunto: <span>(*)</span></label> \n"
                ."<input id=\"mail_asnt\" name=\"mail_asnt\" type=\"text\" class=\"input-text input_largo\" /> \n"
                ."</div>";
    //--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------//

            // Mensaje
            echo "<div class=\"form-group\"> \n"
                ."<label for=\"mail_mnsj\">Mensaje: <span>(*)</span></label> \n"
                ."<textarea id=\"mail_mnsj\" name=\"mail_mnsj\" class=\"input_largo\"></textarea> \n"
                ."</div>";   
     //--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------//

            // Archivos adjuntos
            echo "<script type=\"text/javascript\"> \n" 
                ."$(function(){ \n"
                // Clona la fila oculta que tiene los campos base, y la agrega al final de la tabla
                ."$(\"#agregar_ttls\").on('click', function(){ \n"
                ."$(\"#tabla_ttls tbody tr:eq(0)\").clone().removeClass('fila-base').appendTo(\"#tabla_ttls tbody\"); \n"
                ."}); \n"

                // Evento que selecciona la fila y la elimina 
                ."$(document).on(\"click\",\".eliminar\",function(){ \n"
                ."var parent = $(this).parents().get(0); \n"
                ."$(parent).remove(); \n"
                ."}); \n"
                ."}); \n" 
                ."</script> \n";

            // Tabla con los campos para seleccionar las habitaciones                        
            echo "<table id=\"tabla_ttls\" class=\"table_form_steps\"> \n"
                ."<tbody> \n"
                ."<tr class=\"fila-base\"> \n"

                // Adjuntos
                ."<td> \n"
                ."<div class=\"form-group\"> \n" 
                ."<label for=\"mail_adjn\">Archivo Adjunto: <span>(*)</span></label> \n"
                ."<input id=\"mail_adjn\" name=\"mail_adjn[]\" type=\"text\" size=\"60\" class=\"input-text input_file\"/> \n"
                ."<a  \n";
            echo "href=\"javascript:open_popup('".$path."components/filemanager/dialog.php?type=2&editor=mce_0&fldr=email&popup=1&field_id=mail_adjn')\" \n";

            echo "class=\"button btn-medium silver\" type=\"button\">Seleccione</a> \n"
                ."</div> \n"
                ."</td> \n"

                // Eliminar la fila
                ."<td class=\"eliminar\"><a>Eliminar</a></td> \n"
                ."</tr> \n"

                ."</tbody> \n"    
                ."</table> \n"

                // Boton de agregar nuevos campos
                ."<div class=\"form-group row\"> \n"
                ."<div class=\"col-sm-4 col-md-3\"> \n"
                ."<button type=\"button\" id=\"agregar_ttls\" class=\"full-width btn-medium yellow\">Adjuntar otro archivo</button> \n"
                ."</div> \n"
                ."</div> \n"

                ."<hr /> \n";
    //--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------//

            // Cierre del formulario
            echo "<div class=\"form-group\"> \n"           
                ."<button name=\"enviar\" class=\"button btn-medium green \" type=\"submit\" value=\"importar\">Enviar</button> \n"
                ."</div> \n";

            echo "<input type=\"hidden\" value=\"enviar\" name=\"action\" /> \n";

            echo "</form> \n"

                ."</fieldset> \n"

                ."</div> \n"
                ."</div> \n"
                ."</div><!-- row --> \n";  
        }
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------// 

    } // Fin de la validacion de la session
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------// 

    //Pie de pagina
    $sjs = "";
    CommonFooter($path, $sjs, $config);
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------// 

?>