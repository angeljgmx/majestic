<?php

    /********************************************************/
    /* Administrador Web SmartNova                            
    /* Funciones de para el manejo de twitter               
    /* Junio de 2016                                        
    /********************************************************/

//--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------//
    
    // http://blog.unijimpe.net/obtener-thumbnails-de-los-videos-de-youtube/
    function getYoutubeID($url) {
        $tube = parse_url($url);
        if ($tube["path"] == "/watch") {
            parse_str($tube["query"], $query);
            $id = $query["v"];
        } else {
            $id = "";  
        }
        return $id;
    }
//--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------//

    function YouTubeLechPlayListJSONEncode($path, $id, $yt_playlist_id){
        
        // estructura del URL para obtener 50 registros via JSON
        //https://www.googleapis.com/youtube/v3/playlistItems?part=snippet&maxResults=50&playlistId={PLAYLIST_ID}&key={KEY}
        //google api key AIzaSyADHUTYYj1yElyvNQcDNizOyJ-cK0fn734
        // Carga del archivo xml con las noticias externas
        
        require_once $path.'inc/db.inc.php';
        require_once $path.'inc/config.inc.php';
    
        // Control de errores
        $debug = DEBUG; 


        // Crear la instancia y conectar a la BD
        $conec = new itl_db();
        $conec->itl_dbConexion(); 

        $datos = file_get_contents("https://www.googleapis.com/youtube/v3/playlistItems?part=snippet&maxResults=50&playlistId=".$yt_playlist_id."&key=AIzaSyADHUTYYj1yElyvNQcDNizOyJ-cK0fn734");
        
        $json = json_decode($datos, true);
        
        
        for ($i = 0; $i <= 49; $i++) { 
            
            $item_plst = $id;
            $item_etag = $json['items'][$i]['etag'];
            $item_plid = $json['items'][$i]['id'];
            $item_fpub = date('Y-m-d H:i:s', strtotime($json['items'][$i]['snippet']['publishedAt']));
            $item_chid = $json['items'][$i]['snippet']['channelId'];
            $item_ttle = ReemSpecialChars($json['items'][$i]['snippet']['title']);
            $item_desc = ReemSpecialChars($json['items'][$i]['snippet']['description']);
            $item_thum = $json['items'][$i]['snippet']['thumbnails']['default']['url'];
            $item_idvd = $json['items'][$i]['snippet']['resourceId']['videoId'];
            
            // Consultar si existe el registro                 
            $sql_existe = "SELECT item_idvd FROM yutb_item WHERE item_idvd = '".$item_idvd."'";
            $query_existe = $conec->itl_dbQuery($sql_existe, $debug);
            $existe = $conec->itl_dbNumRows($query_existe);
            
            if ($existe == 0){
                
                // Insertat el registro en la tabla 
                $sql_insertar = "INSERT INTO yutb_item (item_plst,item_etag,item_plid,item_fpub,item_chid,item_ttle,item_desc,item_thum,item_idvd, item_estd) "
                    ."VALUES ('".$item_plst."', '".$item_etag."', '".$item_plid."', '".$item_fpub."', '".$item_chid."', '".$item_ttle."', '".$item_desc."', '".$item_thum."', '".$item_idvd."', '1')";
                $sql_query = $conec->itl_dbQuery($sql_insertar, $debug);
                
                if ($sql_query){
                    echo $item_idvd." Se ha insertado con exito <br />";
                }
                else {
                    echo $item_idvd." hubo un problema y no se pudo insertar <br />";
                }                
            }            
        }
    }
//--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------//

?> 