<?php

    /********************************************************/
    /* Administrador Web SmartNova                            */
    /* Funciones de Seguridad                               */
    /* Junio de 2016                                        */
    /********************************************************/

//--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------//

    // Clase para  prevenir ataques CSRF o XSS mediante parámetros GET.		
    class dXSS{
    var $url;
    var $longitud;

    function TestGet($path){
        $ok = true;
        $baneados =array(chr(34),
        "'",
        "--",
        ";",
        "<",
        "[",
        "&lt;",
        ">",
        "&gt",
        "&quot",
        "&#x27",
        "%",
        "&#x2F",
        "/*",
        "*/",
        "request",
        "select",
        "declare",
        "insert",
        "update",
        "delete",
        "drop",
        "exec(",
        "execute(",
        "cast(",
        "char",
        "nchar",
        "varchar",
        "nvarchar", 
        "substring",
        "sysobject",
        "iframe",
        "syscolumns"
        );

        $recuento=0;
        foreach( $_GET as $key => $value ) {
            for($i=0;$i<sizeof($baneados);$i++) {
                $Cadena = strtoupper($value);
                $Encontrar   = strtoupper($baneados[$i]);
                $pos = strpos($Cadena, $Encontrar);
                if($pos !== false) {
                    $recuento++;
                    }
                if(strlen($Cadena)>$this->longitud){
                    $recuento++;
                    }
                if(preg_match('[^a-z0-9_]',$Cadena)){
                    $recuento++;
                    }	
                }
            }
        if($recuento>0){
           // header('Location: '.$path.'ataque.php');
            }
        }
    }	
//--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------//

    function Seguridad($path){
        
        include_once $path.'includes/config.inc.php';

        // Evitar ataques CSRF o XSS mediante parámetros GET.
        $g = new dXSS();
        $g->url = PREF_URL;
        $g->longitud = 10;
        $g->TestGet($path);

        // Evitamos la inyeccion SQL en los formularios de la pagina
        // Modificamos las variables pasadas por URL 
        foreach( $_GET as $variable => $valor ){ 
            $_GET [ $variable ] = str_replace ( "'" , "'" , $_GET [ $variable ]); 
        } 
        // Modificamos las variables de formularios 
        foreach( $_POST as $variable => $valor ){ 
            $_POST [ $variable ] = str_replace ( "'" , "'" , $_POST [ $variable ]); 
        } 
    }
//--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------//

    function PermisosModulo($path){
        
        // inclusion de las funciones de bases de datos
        require_once $path."core/db.class.core.php";
        require_once $path."includes/config.inc.php";
        
        $debug = DEBUG;
        
        if ($_SESSION['mdlo_code'] != "MD-PERFIL"){
            // Crear la instancia y conectar a la BD
            $conec = new db();
            $conec->dbConexion();
            $sql_perm = "SELECT admd_adms, admd_mdlo, admd_cons, admd_insr, admd_edit, admd_elim, tbla_mdlo.id, mdlo_code "
                ."FROM tbla_admd "
                ."INNER JOIN tbla_mdlo ON (tbla_mdlo.id = admd_mdlo) "
                ."WHERE (admd_adms = '".$_SESSION['sson_idpr']."') AND (mdlo_code = '".$_SESSION['mdlo_code']."')";
            $query_perm = $conec->dbQuery($sql_perm, $debug);
            $datos_perm = $conec->dbFetchObjet($query_perm);

            @$permisos['cons'] = $datos_perm->admd_cons;
            @$permisos['insr'] = $datos_perm->admd_insr;
            @$permisos['edit'] = $datos_perm->admd_edit;
            @$permisos['elim'] = $datos_perm->admd_elim;
        }
        else {
            $permisos['perf'] = TRUE;
        }
        
        return $permisos; 
    }
//--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------//
?>    