<?php 
    /********************************************************/
    /* Administrador Web SmartNova
    /* CRUD - Administradores
    /* 02-7-2016
    /********************************************************/

//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------// 

    // Inicio de sesion
    session_start(); 
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------// 

    // UbicaciÃ³n del archivo 
    $path = "../"; 
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------// 

    // Inclusion de archivos necesarios 
    require_once $path."core/core.php"; 
    Core($path);
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------// 

    // Seguridad 
    Seguridad($path);
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------// 

    // Identificador del modulo
    $_SESSION['mdlo_code'] = "MD-PERFIL";
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------// 

    // Objetivo para los formularios, los enlaces y las funciones 
    $objetivo = basename($_SERVER["PHP_SELF"]); 
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------// 

    // Control de errores
    $debug = DEBUG;
//--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------//
    
    // Crear la instancia y conectar a la BD
    $conec = new db();
    $conec->dbConexion();
//--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------//

    
    // Permisos del modulo
    $permisos = PermisosModulo($path); 
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------// 

    //Encabezado de la pagina
    $page_title = "Editar Perfil";
    $meta = "";
    $css = "";
    $js = "";
    $actions_pagebar = "";
    $config = "";
    CommonHeader($path, $page_title, $meta, $css, $js, $objetivo, $actions_pagebar, $config);
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------// 

    // Validacion de la session
    if (SessionValidate($path, "adms")){
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------// 

        if ($permisos['perf'] == TRUE){
            // Recepcion de la variable de control 
            $control = 0;
            if (@$_POST['control'] == 1){
                $control = 1;
            }

            if ($control == "1"){
                
                // id de la persona
                $idpr = $_SESSION['sson_idpr'];                                            // id de la persona

                // Recepcion de variables del formulario
                $user_pass_act = md5($_POST['user_pass_act']);          // password actual
                $user_pass_new = md5($_POST['user_pass_new']);          // nuevo password
    //------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------//

                // Verificar si el registro existe y si es igual al que se encuentra almacenado en la tabla
                $sql = "SELECT * FROM tbla_adms WHERE id = '".$idpr."' AND adms_pass = '".$user_pass_act."'";
                $query = $conec->dbQuery($sql, $debug);
                $existe = $conec->dbNumRows($query);
                //echo $rs_existe_registro;

                if ($existe == 1){  	

                    // Construccion de la consulta
                    $sche = "";
                    $tabla = "tbla_adms";
                    $set = "adms_pass = '$user_pass_new'";
                    $where = "id = ".$idpr."";
                    $rs_edit = $conec->dbEdicion($sche, $tabla, $set, $where, $debug); 

                    // Mensajes
                    $modal_title = "Cambio de Contrase&ntilde;a";
                    $modal_config = "";
                    
                    if ($rs_edit == 0) {
                        $modal_message = "Ha ocurrido un error al intentar cambiar su contrase&ntilde;a. Intente nuevamente" ;
                        $modal_alert_type = "error";
                        ModalMessage($modal_title, $modal_alert_type, $modal_message, $modal_config);
                    }
                    else {
                        $modal_message = "Se ha cambiado su contrase&ntilde;a con exito. Recuerde usar su nueva contra&ntilde;a al iniciar sesi&oacute;n";
                        $modal_alert_type = "success";
                        ModalMessage($modal_title, $modal_alert_type, $modal_message, $modal_config);
                    }
                }
                else {
                    $modal_message = "Ha ocurrido un error al intentar cambiar su contrase&ntilde;a. Contacte con el Administrador" ;
                    $modal_alert_type = "warning";
                } 

            } // fin de la decision del control 
    //------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------//

            echo "<div class=\"portlet light bordered form-fit\"> \n"

                ."<div class=\"portlet-title\"> \n"
                ."<div class=\"caption\"> \n"
                ."<i class=\"fa fa-th-list font-green-haze\"></i> \n"
                ."<span class=\"caption-subject font-green-haze bold uppercase\">Cambio de Contrase&ntilde;a</span> \n"
                ."</div> \n"
                ."</div> \n";

            // Inicio del cuerpo del formulario
            echo "<div class=\"portlet-body form\"> \n"
                ."<!-- BEGIN FORM--> \n";

            // Inicio de la etiqueta del formulario
            echo "<form id=\"cambio_clave\" name=\"cambio_clave\" action=\"".$objetivo."\" method=\"post\" autocomplete=\"off\"  class=\"form-horizontal form-row-seperated\" > \n"           
                ."<div class=\"form-body\"> \n";        
    //--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------//

            // password 01   
            echo "<div class=\"form-group\"> \n"
                ."<label class=\"control-label col-md-3\" for=\"user_pass_act\">Contrase&ntilde;a actual: <span>(*)</span></label> \n"
                ."<div class=\"col-md-9\"> \n"
                ."<input id=\"user_pass_act\" name=\"user_pass_act\" type=\"password\" class=\"form-control input-large\" placeholder=\"\" required /> \n"
                ."</div>"
                ."</div>";

            // password 02   
            echo "<div class=\"form-group\"> \n" 
                ."<label class=\"control-label col-md-3\" for=\"user_pass_new\">Nueva contrase&ntilde;a: <span>(*)</span></label> \n"
                ."<div class=\"col-md-9\"> \n"
                ."<input id=\"user_pass02\" name=\"user_pass_new\" type=\"password\" class=\"form-control input-large\" placeholder=\"\" required data-equalto=\"#user_pass02\" /> \n"
                ."</div>"
                ."</div>";

            // password 03   
            echo "<div class=\"form-group\"> \n"
                ."<label class=\"control-label col-md-3\" for=\"user_pass_new\">Repita su nueva contrase&ntilde;a: <span>(*)</span></label> \n"
                ."<div class=\"col-md-9\"> \n"
                ."<input id=\"user_pass03\" name=\"user_pass_new\" type=\"password\" class=\"form-control input-large\" placeholder=\"\" required data-equalto=\"#user_pass02\" /> \n"
                ."</div>"
                ."</div>";

            // Acciones del formulario 
            echo "<div class=\"form-actions\"> \n"
                ."<div class=\"row\"> \n"
                ."<div class=\"col-md-offset-3 col-md-9\"> \n"
                ."<button type=\"submit\" class=\"btn green\"><i class=\"fa fa-pencil\"></i> Enviar</button> \n"
                ."<button type=\"reset\" class=\"btn default\"><i class=\"fa fa-eraser\"></i> Cancelar</button> \n"
                ."</div> \n"
                ."</div> \n"
                ."</div> \n";

            // Variables ocultas de control
            echo "<input type=\"hidden\" id=\"control\" name=\"control\" value=\"1\"> \n";        
            echo "<input type=\"hidden\" id=\"op\" name=\"op\" value=\"cambiar_clave\"> \n";
            echo "<input type=\"hidden\" id=\"id\" name=\"id\" value=\"".$_SESSION['sson_idpr']."\"> \n";           
    //--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------//

            // Cierre del formulario
            echo "</div><!-- form-body --> \n"
                ."</form> \n"
                ."<!-- END FORM--> \n"
                ."</div><!-- end portlet> \n";
        }
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------// 

    } // Fin de la validacion de la session
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------// 

    //Pie de pagina
    $sjs = "";
    CommonFooter($path, $sjs, $config);
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------// 

?>